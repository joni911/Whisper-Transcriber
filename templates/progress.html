<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress - Whisper Transcriber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .time-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üîÑ Proses Transkripsi</h1>
            <a href="/" class="btn btn-secondary">‚Üê Kembali</a>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 id="fileName">Memproses file...</h5>
            </div>
            <div class="card-body">
                <!-- Time Information Cards -->
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="card time-card">
                            <div class="card-body text-center">
                                <div class="small">‚è±Ô∏è Waktu Berjalan</div>
                                <div id="elapsedTime" class="timer-display">00:00:00</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card time-card">
                            <div class="card-body text-center">
                                <div class="small">‚è∞ Estimasi</div>
                                <div id="estimatedTime" class="timer-display">--:--:--</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card time-card">
                            <div class="card-body text-center">
                                <div class="small">‚è≥ Sisa Waktu</div>
                                <div id="remainingTime" class="timer-display">--:--:--</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="text-center mb-4">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <h4 id="progressText" class="text-muted">Memulai proses...</h4>
                </div>
                
                <!-- Log Output -->
                <div class="mt-4">
                    <h6>üìù Log Proses:</h6>
                    <div id="logOutput" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.9em;"></div>
                </div>
                
                <!-- Completion Message -->
                <div id="completionMessage" class="mt-4 text-center" style="display: none;">
                    <div class="alert alert-success">
                        <h5>‚úÖ Transkripsi Selesai!</h5>
                        <p>File telah berhasil ditranskripsi dan disimpan.</p>
                        <div class="mt-3">
                            <a href="/" class="btn btn-success btn-lg">Lihat Hasil</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const jobId = '{{ job_id }}';
        const logOutput = document.getElementById('logOutput');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const fileName = document.getElementById('fileName');
        const completionMessage = document.getElementById('completionMessage');
        
        // Time elements
        const elapsedTime = document.getElementById('elapsedTime');
        const estimatedTime = document.getElementById('estimatedTime');
        const remainingTime = document.getElementById('remainingTime');
        
        let startTime = null;
        let estimatedMinutes = 0;
        
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function addToLog(message) {
            const time = new Date().toLocaleTimeString();
            logOutput.innerHTML += `[${time}] ${message}<br>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function updateTimers(data) {
            // Update elapsed time
            if (data.elapsed_time) {
                elapsedTime.textContent = formatTime(data.elapsed_time);
            }
            
            // Update estimated time
            if (data.estimated_time && data.estimated_time > 0) {
                estimatedMinutes = data.estimated_time;
                estimatedTime.textContent = formatTime(data.estimated_time * 60);
            }
            
            // Update remaining time
            if (data.elapsed_time && estimatedMinutes > 0) {
                const remaining = (estimatedMinutes * 60) - data.elapsed_time;
                if (remaining > 0) {
                    remainingTime.textContent = formatTime(remaining);
                } else {
                    remainingTime.textContent = "00:00:00";
                }
            }
        }
        
        function updateProgress(data) {
            // Update progress bar
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
            progressText.textContent = data.message;
            
            // Update file name
            if (data.filename) {
                fileName.textContent = 'File: ' + data.filename;
            }
            
            // Update timers
            updateTimers(data);
            
            // Add to log
            addToLog(data.message);
            
            // Handle completion
            if (data.status === 'completed') {
                completionMessage.style.display = 'block';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.remove('progress-bar-striped');
                progressBar.classList.add('bg-success');
                
                // Final log entry
                addToLog(`‚úÖ Selesai! Total waktu: ${formatTime(data.elapsed_time || 0)}`);
            } else if (data.status === 'failed') {
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                addToLog('‚ùå Proses gagal!');
            }
        }
        
        // Real-time timer update
        function updateRealTime() {
            fetch(`/progress_status/${jobId}`)
                .then(response => response.json())
                .then(data => {
                    updateProgress(data);
                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(pollInterval);
                        clearInterval(timerInterval);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    addToLog('‚ùå Error koneksi ke server');
                });
        }
        
        // Polling untuk update progress
        const pollInterval = setInterval(updateRealTime, 1000);
        
        // Timer untuk update waktu real-time
        const timerInterval = setInterval(() => {
            // Update elapsed time real-time
            const currentElements = document.querySelectorAll('[id="elapsedTime"]');
            if (currentElements.length > 0) {
                fetch(`/progress_status/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.elapsed_time) {
                            elapsedTime.textContent = formatTime(data.elapsed_time);
                            
                            // Update remaining time real-time
                            if (estimatedMinutes > 0) {
                                const remaining = (estimatedMinutes * 60) - data.elapsed_time;
                                if (remaining > 0) {
                                    remainingTime.textContent = formatTime(remaining);
                                } else {
                                    remainingTime.textContent = "00:00:00";
                                }
                            }
                        }
                    });
            }
        }, 1000);
        
        // Initial log
        addToLog('üöÄ Memulai proses transkripsi...');
    </script>
</body>
</html>