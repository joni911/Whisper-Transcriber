<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Report - Whisper Transcriber</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üìù Generate Laporan AI</h1>
            <a href="/transcript/{{ transcription[0] }}" class="btn btn-secondary">‚Üê Kembali</a>
        </div>
        
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% if not api_key_set %}
            <div class="alert alert-warning">
                ‚ö†Ô∏è API key belum diatur. Silakan atur di <a href="/ai-settings">halaman AI Settings</a>.
            </div>
        {% endif %}
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>File: {{ transcription[2] }}</h5>
                <small class="text-muted">
                    Kata: {{ "{:,}".format(transcription[5] or 0) }} | 
                    Durasi: {% if transcription[4] %}{{ "%.1f"|format(transcription[4]/60) }} menit{% endif %}
                </small>
            </div>
            <div class="card-body">
                <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                    <small>{{ transcription[3][:500] }}{% if transcription[3]|length > 500 %}...{% endif %}</small>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Pilih Jenis Laporan</h5>
            </div>
            <div class="card-body">
                <form id="reportForm">
                    <input type="hidden" name="transcript_id" value="{{ transcription[0] }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Model AI</label>
                        <select class="form-select" name="model_id" id="modelSelect">
                            <option value="">Memuat model...</option>
                        </select>
                        <div class="form-text">
                            Pilih model AI yang akan digunakan. 
                            <a href="/ai-models" target="_blank">Lihat semua model tersedia</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tipe Laporan</label>
                        <div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="report_type" id="summary" value="summary" checked>
                                <label class="form-check-label" for="summary">
                                    üìã Ringkasan - Buat ringkasan komprehensif dari transkripsi
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="report_type" id="analysis" value="analysis">
                                <label class="form-check-label" for="analysis">
                                    üîç Analisis - Analisis mendalam terhadap konten
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="report_type" id="custom" value="custom">
                                <label class="form-check-label" for="custom">
                                    üéØ Kustom - Buat laporan berdasarkan instruksi Anda
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="analysisOptions" style="display: none;">
                        <label class="form-label">Tipe Analisis</label>
                        <select class="form-select" name="analysis_type">
                            <option value="general">Analisis Umum</option>
                            <option value="sentiment">Analisis Sentimen</option>
                            <option value="keypoints">Poin Kunci</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="customPrompt" style="display: none;">
                        <label for="custom_prompt" class="form-label">Instruksi Kustom</label>
                        <textarea class="form-control" id="custom_prompt" name="custom_prompt" rows="4"
                                  placeholder="Contoh: Buat daftar action items dari transkripsi ini. Identifikasi semua tugas yang perlu dilakukan beserta deadline-nya."></textarea>
                        <div class="form-text">
                            Berikan instruksi spesifik tentang jenis laporan yang ingin Anda buat.
                            <strong>Pastikan instruksi Anda jelas dan spesifik.</strong>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" {% if not api_key_set %}disabled{% endif %}>
                        ü§ñ Generate Laporan
                    </button>
                </form>
            </div>
        </div>
        
        <div id="loadingIndicator" class="text-center mt-4" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Menghasilkan laporan dengan AI...</p>
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        // Toggle options based on report type
        document.querySelectorAll('input[name="report_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('analysisOptions').style.display = 
                    this.value === 'analysis' ? 'block' : 'none';
                document.getElementById('customPrompt').style.display = 
                    this.value === 'custom' ? 'block' : 'none';
            });
        });
        
        // Show analysis options by default if analysis is selected
        if (document.getElementById('analysis') && document.getElementById('analysis').checked) {
            document.getElementById('analysisOptions').style.display = 'block';
        }
        
        // Load models with search functionality
        $(document).ready(function() {
            // Load available models
            fetch('/get-models')
                .then(response => response.json())
                .then(data => {
                    const modelSelect = document.getElementById('modelSelect');
                    modelSelect.innerHTML = '';
                    
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'mistralai/mistral-7b-instruct:free';
                    defaultOption.textContent = 'Mistral 7B Instruct (Default - Free)';
                    modelSelect.appendChild(defaultOption);
                    
                    // Add other models
                    if (data.models && data.models.length > 0) {
                        data.models.forEach(model => {
                            if (model.id !== 'mistralai/mistral-7b-instruct:free') {
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.textContent = `${model.name} ${model.is_free ? '(Free)' : '(Premium)'}`;
                                option.dataset.description = model.description || '';
                                modelSelect.appendChild(option);
                            }
                        });
                    }
                    
                    // Initialize Select2 for search functionality
                    $('#modelSelect').select2({
                        placeholder: "Pilih model AI...",
                        allowClear: true,
                        templateResult: formatModel,
                        templateSelection: formatModelSelection
                    });
                })
                .catch(error => {
                    console.log('Could not load models:', error);
                    // Fallback to default models
                    const modelSelect = document.getElementById('modelSelect');
                    modelSelect.innerHTML = `
                        <option value="mistralai/mistral-7b-instruct:free">Mistral 7B Instruct (Default - Free)</option>
                        <option value="google/gemma-2-9b-it:free">Google Gemma 2 9B (Free)</option>
                        <option value="microsoft/phi-3-mini-128k-instruct:free">Microsoft Phi-3 Mini (Free)</option>
                        <option value="openchat/openchat-7b:free">OpenChat 7B (Free)</option>
                    `;
                    
                    $('#modelSelect').select2({
                        placeholder: "Pilih model AI...",
                        allowClear: true
                    });
                });
        });
        
        function formatModel(model) {
            if (!model.id) {
                return model.text;
            }
            
            const $model = $(
                `<span><strong>${model.text}</strong><br><small class="text-muted">${model.element.dataset.description || ''}</small></span>`
            );
            return $model;
        }
        
        function formatModelSelection(model) {
            return model.text;
        }
        
        // Form submission
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate custom prompt if custom report is selected
            const reportType = document.querySelector('input[name="report_type"]:checked').value;
            const customPrompt = document.getElementById('custom_prompt').value;
            
            if (reportType === 'custom' && (!customPrompt || customPrompt.trim() === '')) {
                alert('‚ùå Prompt kustom tidak boleh kosong!');
                return;
            }
            
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            
            // Show loading
            document.getElementById('loadingIndicator').style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Memproses...';
            
            // Send request
            fetch('/create-report', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úÖ ' + data.message);
                    window.location.href = `/report/${data.report_id}`;
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå Error: ' + error.message);
            })
            .finally(() => {
                document.getElementById('loadingIndicator').style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'ü§ñ Generate Laporan';
            });
        });
    </script>
</body>
</html>